# 601.(Hard) ä½“è‚²é¦†çš„äººæµé‡

è¡¨ï¼šStadium
```
+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| id            | int     |
| visit_date    | date    |
| people        | int     |
+---------------+---------+
visit_date æ˜¯è¡¨çš„ä¸»é”®
æ¯æ—¥äººæµé‡ä¿¡æ¯è¢«è®°å½•åœ¨è¿™ä¸‰åˆ—ä¿¡æ¯ä¸­ï¼šåºå· (id)ã€æ—¥æœŸ (visit_date)ã€Â äººæµé‡ (people)
æ¯å¤©åªæœ‰ä¸€è¡Œè®°å½•ï¼Œæ—¥æœŸéšç€ id çš„å¢žåŠ è€Œå¢žåŠ 
```

ç¼–å†™ä¸€ä¸ª SQL æŸ¥è¯¢ä»¥æ‰¾å‡ºæ¯è¡Œçš„**äººæ•°å¤§äºŽæˆ–ç­‰äºŽ 100 ä¸” id è¿žç»­çš„ä¸‰è¡Œæˆ–æ›´å¤šè¡Œè®°å½•**ã€‚

è¿”å›žæŒ‰ visit_date å‡åºæŽ’åˆ—çš„ç»“æžœè¡¨ã€‚

æŸ¥è¯¢ç»“æžœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚
```
Stadium table:
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 1    | 2017-01-01 | 10        |
| 2    | 2017-01-02 | 109       |
| 3    | 2017-01-03 | 150       |
| 4    | 2017-01-04 | 99        |
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+

Result table:
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+
id ä¸º 5ã€6ã€7ã€8 çš„å››è¡Œ id è¿žç»­ï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰ >= 100 çš„äººæ•°è®°å½•ã€‚
è¯·æ³¨æ„ï¼Œå³ä½¿ç¬¬ 7 è¡Œå’Œç¬¬ 8 è¡Œçš„ visit_date ä¸æ˜¯è¿žç»­çš„ï¼Œè¾“å‡ºä¹Ÿåº”å½“åŒ…å«ç¬¬ 8 è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦è€ƒè™‘ id è¿žç»­çš„è®°å½•ã€‚
ä¸è¾“å‡º id ä¸º 2 å’Œ 3 çš„è¡Œï¼Œå› ä¸ºè‡³å°‘éœ€è¦ä¸‰æ¡ id è¿žç»­çš„è®°å½•ã€‚
```


æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰

é“¾æŽ¥ï¼šhttps://leetcode-cn.com/problems/human-traffic-of-stadium 

è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æŽˆæƒï¼Œéžå•†ä¸šè½¬è½½è¯·æ³¨æ˜Žå‡ºå¤„ã€‚



## Solution 


### 1. å˜é‡æ³•

æƒ³å¤æ‚äº†ï¼Œä¸è¿‡å°±å½“ç»ƒä¹ äº†ã€‚

```sql
with t1 as (
	SELECT *, (people>=100) busy
	FROM stadium
),t2 as (
	SELECT id, visit_date, people, busy,
		case 
		when @prev = busy then @slice := @slice
		when (@prev := busy) is not null then @slice := @slice+1 
		end flag
	from t1, (SELECT @prev:=null, @slice:=0) tmp
),t3 as (
select *, count(1) over (partition by flag) cnt from t2
)

SELECT id, visit_date, people from t3 
where busy =1 and cnt>=3 
order by 2
```
- t1 è®¡ç®— busy
- t2 è®¡ç®— flagï¼ˆå˜é‡ï¼‰
- t3 è®¡ç®— cntï¼ˆçª—å£å‡½æ•°ï¼‰
```
id  visit_date   people  busy  flag cnt
1   2017-01-01   10        0    1    1
2   2017-01-02   109       1    2    2
3   2017-01-03   150       1    2    2
4   2017-01-04   99        0    3    1
5   2017-01-05   145       1    4    4
6   2017-01-06   1455      1    4    4
7   2017-01-07   199       1    4    4
8   2017-01-09   188       1    4    4
```
äº‹å®žä¸Šflagåˆ—çš„è®¡ç®—å¯ä»¥ç›´æŽ¥ç”¨  `(id - row_number() OVER(ORDER BY id))` ç»“åˆ `WHERE people >= 100` ä¸€æ­¥åˆ°ä½ï¼Œå¦‚ðŸ‘‡ðŸ»çª—å£å‡½æ•°æ³•

### 2.çª—å£å‡½æ•°æ³•

```sql
with t1 as (
	SELECT  *
			,(id - row_number() OVER(ORDER BY id)) flag
	FROM    stadium
	WHERE   people >= 100
), t2 as (
SELECT *,count(1) over (partition by flag) cnt from t1
)

SELECT id, visit_date, people from t2
where cnt>=3 order by 2
```


## Table Schema

```sql
Create table If Not Exists stadium (id int, visit_date DATE NULL, people int);
Truncate table stadium;
insert into stadium (id, visit_date, people) values ('1', '2017-01-01', '10');
insert into stadium (id, visit_date, people) values ('2', '2017-01-02', '109');
insert into stadium (id, visit_date, people) values ('3', '2017-01-03', '150');
insert into stadium (id, visit_date, people) values ('4', '2017-01-04', '99');
insert into stadium (id, visit_date, people) values ('5', '2017-01-05', '145');
insert into stadium (id, visit_date, people) values ('6', '2017-01-06', '1455');
insert into stadium (id, visit_date, people) values ('7', '2017-01-07', '199');
insert into stadium (id, visit_date, people) values ('8', '2017-01-09', '188');


-- case
Truncate table stadium;
insert into stadium (id, visit_date, people) values ('1', "2017-01-01", '10');
insert into stadium (id, visit_date, people) values ('2', "2017-01-02", '109');
insert into stadium (id, visit_date, people) values ('3', "2017-01-03", '150');
insert into stadium (id, visit_date, people) values ('4', "2017-01-04", '100');
```